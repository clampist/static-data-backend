<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OrganizationService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.staticdata.platform.service</a> &gt; <span class="el_source">OrganizationService.java</span></div><h1>OrganizationService.java</h1><pre class="source lang-java linenums">package com.staticdata.platform.service;

import com.staticdata.platform.dto.CreateOrganizationNodeRequest;
import com.staticdata.platform.dto.OrganizationNodeDto;
import com.staticdata.platform.dto.UpdateOrganizationNodeRequest;
import com.staticdata.platform.entity.OrganizationNode;
import com.staticdata.platform.entity.User;
import com.staticdata.platform.exception.ResourceNotFoundException;
import com.staticdata.platform.exception.BusinessException;
import com.staticdata.platform.repository.OrganizationNodeRepository;
import com.staticdata.platform.repository.UserRepository;
import com.staticdata.platform.security.UserPrincipal;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

/**
 * 组织管理服务类
 */
@Service
@RequiredArgsConstructor
<span class="fc" id="L29">@Slf4j</span>
public class OrganizationService {

    private final OrganizationNodeRepository organizationNodeRepository;
    private final UserRepository userRepository;

    /**
     * 获取完整的组织树
     */
    @Transactional(readOnly = true)
    public List&lt;OrganizationNodeDto&gt; getOrganizationTree() {
<span class="fc" id="L40">        log.info(&quot;Getting organization tree&quot;);</span>
        
        // 获取所有节点
<span class="fc" id="L43">        List&lt;OrganizationNode&gt; allNodes = organizationNodeRepository.findAll();</span>
        
<span class="pc bpc" id="L45" title="1 of 2 branches missed.">        if (allNodes.isEmpty()) {</span>
<span class="nc" id="L46">            return new ArrayList&lt;&gt;();</span>
        }
        
        // 构建树状结构
<span class="fc" id="L50">        return buildTree(allNodes);</span>
    }

    /**
     * 根据父节点ID获取子节点
     */
    @Transactional(readOnly = true)
    public List&lt;OrganizationNodeDto&gt; getChildrenByParentId(Long parentId) {
<span class="fc" id="L58">        log.info(&quot;Getting children for parent node: {}&quot;, parentId);</span>
        
        List&lt;OrganizationNode&gt; children;
<span class="pc bpc" id="L61" title="1 of 2 branches missed.">        if (parentId == null) {</span>
<span class="nc" id="L62">            children = organizationNodeRepository.findByParentIdIsNullOrderBySortOrderAsc();</span>
        } else {
<span class="fc" id="L64">            children = organizationNodeRepository.findByParentIdOrderBySortOrderAsc(parentId);</span>
        }
        
<span class="fc" id="L67">        return children.stream()</span>
<span class="fc" id="L68">                .map(this::convertToDto)</span>
<span class="fc" id="L69">                .collect(Collectors.toList());</span>
    }

    /**
     * 根据ID获取节点详情
     */
    @Transactional(readOnly = true)
    public OrganizationNodeDto getNodeById(Long id) {
<span class="fc" id="L77">        log.info(&quot;Getting organization node by id: {}&quot;, id);</span>
        
<span class="fc" id="L79">        OrganizationNode node = organizationNodeRepository.findById(id)</span>
<span class="pc" id="L80">                .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;组织节点不存在: &quot; + id));</span>
        
<span class="fc" id="L82">        return convertToDto(node);</span>
    }

    /**
     * 创建组织节点
     */
    @Transactional
    public OrganizationNodeDto createNode(CreateOrganizationNodeRequest request) {
<span class="fc" id="L90">        log.info(&quot;Creating organization node: {}&quot;, request.getName());</span>
        
        // 验证父节点是否存在
<span class="fc bfc" id="L93" title="All 2 branches covered.">        if (request.getParentId() != null) {</span>
<span class="fc" id="L94">            organizationNodeRepository.findById(request.getParentId())</span>
<span class="pc" id="L95">                    .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;父节点不存在: &quot; + request.getParentId()));</span>
        }
        
        // 检查名称是否重复
<span class="pc bpc" id="L99" title="1 of 2 branches missed.">        if (isNameDuplicate(request.getName(), request.getParentId(), null)) {</span>
<span class="fc" id="L100">            throw new BusinessException(&quot;同一层级下已存在相同名称的节点: &quot; + request.getName());</span>
        }
        
        // 获取当前用户
<span class="nc" id="L104">        String currentUser = getCurrentUsername();</span>
        
        // 创建新节点
<span class="nc" id="L107">        OrganizationNode node = new OrganizationNode();</span>
<span class="nc" id="L108">        node.setName(request.getName());</span>
<span class="nc" id="L109">        node.setDescription(request.getDescription());</span>
<span class="nc" id="L110">        node.setType(request.getType());</span>
<span class="nc" id="L111">        node.setParentId(request.getParentId());</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">        node.setSortOrder(request.getSortOrder() != null ? request.getSortOrder() : 0);</span>
<span class="nc" id="L113">        node.setCreatedBy(currentUser);</span>
<span class="nc" id="L114">        node.setUpdatedBy(currentUser);</span>
        
<span class="nc" id="L116">        OrganizationNode savedNode = organizationNodeRepository.save(node);</span>
        
<span class="nc" id="L118">        log.info(&quot;Created organization node: {} with id: {}&quot;, savedNode.getName(), savedNode.getId());</span>
        
<span class="nc" id="L120">        return convertToDto(savedNode);</span>
    }

    /**
     * 更新组织节点
     */
    @Transactional
    public OrganizationNodeDto updateNode(Long id, UpdateOrganizationNodeRequest request) {
<span class="fc" id="L128">        log.info(&quot;Updating organization node: {}&quot;, id);</span>
        
<span class="fc" id="L130">        OrganizationNode node = organizationNodeRepository.findById(id)</span>
<span class="pc" id="L131">                .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;组织节点不存在: &quot; + id));</span>
        
        // 检查名称是否重复
<span class="pc bpc" id="L134" title="1 of 2 branches missed.">        if (isNameDuplicate(request.getName(), node.getParentId(), id)) {</span>
<span class="nc" id="L135">            throw new BusinessException(&quot;同一层级下已存在相同名称的节点: &quot; + request.getName());</span>
        }
        
        // 获取当前用户
<span class="fc" id="L139">        String currentUser = getCurrentUsername();</span>
        
        // 更新节点信息
<span class="fc" id="L142">        node.setName(request.getName());</span>
<span class="fc" id="L143">        node.setDescription(request.getDescription());</span>
<span class="pc bpc" id="L144" title="1 of 2 branches missed.">        if (request.getSortOrder() != null) {</span>
<span class="fc" id="L145">            node.setSortOrder(request.getSortOrder());</span>
        }
<span class="fc" id="L147">        node.setUpdatedBy(currentUser);</span>
        
<span class="fc" id="L149">        OrganizationNode updatedNode = organizationNodeRepository.save(node);</span>
        
<span class="fc" id="L151">        log.info(&quot;Updated organization node: {}&quot;, updatedNode.getName());</span>
        
<span class="fc" id="L153">        return convertToDto(updatedNode);</span>
    }

    /**
     * 删除组织节点
     */
    @Transactional
    public void deleteNode(Long id) {
<span class="nc" id="L161">        log.info(&quot;Deleting organization node: {}&quot;, id);</span>
        
<span class="nc" id="L163">        OrganizationNode node = organizationNodeRepository.findById(id)</span>
<span class="nc" id="L164">                .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;组织节点不存在: &quot; + id));</span>
        
        // 检查是否有子节点
<span class="nc" id="L167">        List&lt;OrganizationNode&gt; children = organizationNodeRepository.findByParentIdOrderBySortOrderAsc(id);</span>
<span class="nc bnc" id="L168" title="All 2 branches missed.">        if (!children.isEmpty()) {</span>
<span class="nc" id="L169">            throw new BusinessException(&quot;无法删除包含子节点的节点，请先删除所有子节点&quot;);</span>
        }
        
        // 检查是否有关联的数据文件
        // TODO: 添加数据文件关联检查
        
<span class="nc" id="L175">        organizationNodeRepository.delete(node);</span>
        
<span class="nc" id="L177">        log.info(&quot;Deleted organization node: {}&quot;, node.getName());</span>
<span class="nc" id="L178">    }</span>

    /**
     * 搜索组织节点
     */
    @Transactional(readOnly = true)
    public List&lt;OrganizationNodeDto&gt; searchNodes(String keyword) {
<span class="nc" id="L185">        log.info(&quot;Searching organization nodes with keyword: {}&quot;, keyword);</span>
        
<span class="nc bnc" id="L187" title="All 4 branches missed.">        if (keyword == null || keyword.trim().isEmpty()) {</span>
<span class="nc" id="L188">            return getOrganizationTree();</span>
        }
        
<span class="nc" id="L191">        List&lt;OrganizationNode&gt; nodes = organizationNodeRepository.findByNameContainingIgnoreCase(keyword.trim());</span>
        
<span class="nc" id="L193">        return nodes.stream()</span>
<span class="nc" id="L194">                .map(this::convertToDto)</span>
<span class="nc" id="L195">                .collect(Collectors.toList());</span>
    }

    /**
     * 移动节点到新的父节点下
     */
    @Transactional
    public OrganizationNodeDto moveNode(Long nodeId, Long newParentId) {
<span class="fc" id="L203">        log.info(&quot;Moving node {} to parent {}&quot;, nodeId, newParentId);</span>
        
<span class="fc" id="L205">        OrganizationNode node = organizationNodeRepository.findById(nodeId)</span>
<span class="pc" id="L206">                .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;组织节点不存在: &quot; + nodeId));</span>
        
        // 验证新父节点是否存在
<span class="pc bpc" id="L209" title="1 of 2 branches missed.">        if (newParentId != null) {</span>
<span class="fc" id="L210">            organizationNodeRepository.findById(newParentId)</span>
<span class="pc" id="L211">                    .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;目标父节点不存在: &quot; + newParentId));</span>
        }
        
        // 检查是否会形成循环引用
<span class="pc bpc" id="L215" title="1 of 2 branches missed.">        if (wouldCreateCircularReference(nodeId, newParentId)) {</span>
<span class="nc" id="L216">            throw new BusinessException(&quot;不能将节点移动到其子节点下&quot;);</span>
        }
        
        // 检查新位置是否有重名
<span class="pc bpc" id="L220" title="1 of 2 branches missed.">        if (isNameDuplicate(node.getName(), newParentId, nodeId)) {</span>
<span class="nc" id="L221">            throw new BusinessException(&quot;目标位置已存在相同名称的节点: &quot; + node.getName());</span>
        }
        
        // 获取当前用户
<span class="fc" id="L225">        String currentUser = getCurrentUsername();</span>
        
        // 更新节点
<span class="fc" id="L228">        node.setParentId(newParentId);</span>
<span class="fc" id="L229">        node.setUpdatedBy(currentUser);</span>
        
<span class="fc" id="L231">        OrganizationNode updatedNode = organizationNodeRepository.save(node);</span>
        
<span class="fc" id="L233">        log.info(&quot;Moved node {} to parent {}&quot;, nodeId, newParentId);</span>
        
<span class="fc" id="L235">        return convertToDto(updatedNode);</span>
    }

    /**
     * 构建树状结构
     */
    private List&lt;OrganizationNodeDto&gt; buildTree(List&lt;OrganizationNode&gt; nodes) {
        // 创建ID到节点的映射
<span class="fc" id="L243">        Map&lt;Long, OrganizationNodeDto&gt; nodeMap = nodes.stream()</span>
<span class="fc" id="L244">                .map(this::convertToDto)</span>
<span class="fc" id="L245">                .collect(Collectors.toMap(OrganizationNodeDto::getId, dto -&gt; dto));</span>
        
        // 构建父子关系
<span class="fc" id="L248">        List&lt;OrganizationNodeDto&gt; rootNodes = new ArrayList&lt;&gt;();</span>
        
<span class="fc bfc" id="L250" title="All 2 branches covered.">        for (OrganizationNodeDto dto : nodeMap.values()) {</span>
<span class="fc bfc" id="L251" title="All 2 branches covered.">            if (dto.getParentId() == null) {</span>
<span class="fc" id="L252">                rootNodes.add(dto);</span>
            } else {
<span class="fc" id="L254">                OrganizationNodeDto parent = nodeMap.get(dto.getParentId());</span>
<span class="pc bpc" id="L255" title="1 of 2 branches missed.">                if (parent != null) {</span>
<span class="fc bfc" id="L256" title="All 2 branches covered.">                    if (parent.getChildren() == null) {</span>
<span class="fc" id="L257">                        parent.setChildren(new ArrayList&lt;&gt;());</span>
                    }
<span class="fc" id="L259">                    parent.getChildren().add(dto);</span>
                }
            }
<span class="fc" id="L262">        }</span>
        
        // 对每个层级的子节点进行排序
<span class="fc" id="L265">        sortChildren(rootNodes);</span>
        
<span class="fc" id="L267">        return rootNodes;</span>
    }

    /**
     * 递归排序子节点
     */
    private void sortChildren(List&lt;OrganizationNodeDto&gt; children) {
<span class="pc bpc" id="L274" title="1 of 4 branches missed.">        if (children != null &amp;&amp; !children.isEmpty()) {</span>
<span class="fc" id="L275">            children.sort((a, b) -&gt; {</span>
<span class="fc" id="L276">                int sortOrderCompare = Integer.compare(</span>
<span class="pc bpc" id="L277" title="1 of 2 branches missed.">                        a.getSortOrder() != null ? a.getSortOrder() : 0,</span>
<span class="pc bpc" id="L278" title="1 of 2 branches missed.">                        b.getSortOrder() != null ? b.getSortOrder() : 0</span>
                );
<span class="pc bpc" id="L280" title="1 of 2 branches missed.">                if (sortOrderCompare == 0) {</span>
<span class="fc" id="L281">                    return a.getName().compareTo(b.getName());</span>
                }
<span class="nc" id="L283">                return sortOrderCompare;</span>
            });
            
            // 递归排序每个节点的子节点
<span class="fc" id="L287">            children.forEach(child -&gt; sortChildren(child.getChildren()));</span>
        }
<span class="fc" id="L289">    }</span>

    /**
     * 检查名称是否重复
     */
    private boolean isNameDuplicate(String name, Long parentId, Long excludeId) {
<span class="fc bfc" id="L295" title="All 2 branches covered.">        if (excludeId == null) {</span>
<span class="fc" id="L296">            excludeId = -1L; // 使用一个不存在的ID</span>
        }
        
<span class="fc bfc" id="L299" title="All 2 branches covered.">        if (parentId == null) {</span>
<span class="fc" id="L300">            return organizationNodeRepository.existsByNameAndParentIdIsNullAndIdNot(name, excludeId);</span>
        } else {
<span class="fc" id="L302">            return organizationNodeRepository.existsByNameAndParentIdAndIdNot(name, parentId, excludeId);</span>
        }
    }

    /**
     * 检查是否会形成循环引用
     */
    private boolean wouldCreateCircularReference(Long nodeId, Long newParentId) {
<span class="pc bpc" id="L310" title="2 of 4 branches missed.">        if (newParentId == null || newParentId.equals(nodeId)) {</span>
<span class="nc" id="L311">            return false;</span>
        }
        
<span class="fc" id="L314">        List&lt;OrganizationNode&gt; parents = organizationNodeRepository.findAllParentsRecursively(newParentId);</span>
<span class="pc" id="L315">        return parents.stream().anyMatch(parent -&gt; parent.getId().equals(nodeId));</span>
    }

    /**
     * 实体转换为DTO
     */
    private OrganizationNodeDto convertToDto(OrganizationNode node) {
<span class="fc" id="L322">        OrganizationNodeDto dto = OrganizationNodeDto.builder()</span>
<span class="fc" id="L323">                .id(node.getId())</span>
<span class="fc" id="L324">                .name(node.getName())</span>
<span class="fc" id="L325">                .description(node.getDescription())</span>
<span class="fc" id="L326">                .type(node.getType())</span>
<span class="fc" id="L327">                .parentId(node.getParentId())</span>
<span class="fc" id="L328">                .sortOrder(node.getSortOrder())</span>
<span class="fc" id="L329">                .createdAt(node.getCreatedAt())</span>
<span class="fc" id="L330">                .updatedAt(node.getUpdatedAt())</span>
<span class="fc" id="L331">                .createdBy(node.getCreatedBy())</span>
<span class="fc" id="L332">                .updatedBy(node.getUpdatedBy())</span>
<span class="fc" id="L333">                .build();</span>
        
        // 设置父节点名称
<span class="fc bfc" id="L336" title="All 2 branches covered.">        if (node.getParentId() != null) {</span>
<span class="fc" id="L337">            organizationNodeRepository.findById(node.getParentId())</span>
<span class="fc" id="L338">                    .ifPresent(parent -&gt; dto.setParentName(parent.getName()));</span>
        }
        
        // 统计子节点数量
<span class="fc" id="L342">        dto.setChildrenCount(organizationNodeRepository.countChildrenByParentId(node.getId()));</span>
        
        // TODO: 统计数据文件数量
<span class="fc" id="L345">        dto.setDataFilesCount(0L);</span>
        
<span class="fc" id="L347">        return dto;</span>
    }

    /**
     * 获取当前用户名
     */
    private String getCurrentUsername() {
        try {
<span class="fc" id="L355">            UserPrincipal userPrincipal = (UserPrincipal) SecurityContextHolder.getContext()</span>
<span class="fc" id="L356">                    .getAuthentication().getPrincipal();</span>
<span class="fc" id="L357">            return userPrincipal.getUsername();</span>
<span class="nc" id="L358">        } catch (Exception e) {</span>
<span class="nc" id="L359">            log.warn(&quot;Failed to get current user, using SYSTEM as default&quot;);</span>
<span class="nc" id="L360">            return &quot;SYSTEM&quot;;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>