<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DataFileService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.staticdata.platform.service</a> &gt; <span class="el_source">DataFileService.java</span></div><h1>DataFileService.java</h1><pre class="source lang-java linenums">package com.staticdata.platform.service;

import com.staticdata.platform.dto.*;
import com.staticdata.platform.entity.DataFile;
import com.staticdata.platform.entity.OrganizationNode;
import com.staticdata.platform.entity.User;
import com.staticdata.platform.exception.BusinessException;
import com.staticdata.platform.exception.ResourceNotFoundException;
import com.staticdata.platform.repository.DataFileRepository;
import com.staticdata.platform.repository.OrganizationNodeRepository;
import com.staticdata.platform.repository.UserRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;
import java.time.LocalDateTime;
import java.util.*;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
<span class="fc" id="L30">@Slf4j</span>
public class DataFileService {

  private final DataFileRepository dataFileRepository;
  private final OrganizationNodeRepository organizationNodeRepository;
  private final UserRepository userRepository;

  @Transactional
  public DataFileDto createDataFile(CreateDataFileRequest request) {
<span class="fc" id="L39">    log.info(&quot;Creating data file: {}&quot;, request.getName());</span>

    // 验证组织节点是否存在
<span class="fc" id="L42">    OrganizationNode organizationNode =</span>
<span class="fc" id="L43">        organizationNodeRepository.findById(request.getOrganizationNodeId()).orElseThrow(</span>
<span class="fc" id="L44">            () -&gt; new ResourceNotFoundException(&quot;组织节点不存在，ID: &quot; + request.getOrganizationNodeId()));</span>

    // 验证模块类型（数据文件只能挂在MODULE类型的节点下）
<span class="pc bpc" id="L47" title="1 of 2 branches missed.">    if (organizationNode.getType() != OrganizationNode.NodeType.MODULE) {</span>
<span class="nc" id="L48">      throw new BusinessException(&quot;数据文件只能挂在功能模块下，当前节点类型为: &quot; + organizationNode.getType());</span>
    }

    // 检查文件名在同一组织节点下是否唯一
<span class="pc bpc" id="L52" title="1 of 2 branches missed.">    if (dataFileRepository.existsByNameAndOrganizationNodeId(request.getName(),</span>
<span class="fc" id="L53">        request.getOrganizationNodeId())) {</span>
<span class="nc" id="L54">      throw new BusinessException(&quot;在同一模块下，数据文件名已存在: &quot; + request.getName());</span>
    }

    // 获取当前用户
<span class="fc" id="L58">    String currentUsername = SecurityContextHolder.getContext().getAuthentication().getName();</span>
<span class="fc" id="L59">    User owner = userRepository.findByUsername(currentUsername)</span>
<span class="pc" id="L60">        .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;用户不存在: &quot; + currentUsername));</span>

    // 创建数据文件实体
<span class="fc" id="L63">    DataFile dataFile = new DataFile();</span>
<span class="fc" id="L64">    dataFile.setName(request.getName());</span>
<span class="fc" id="L65">    dataFile.setDescription(request.getDescription());</span>
<span class="fc" id="L66">    dataFile.setOrganizationNode(organizationNode);</span>
<span class="fc" id="L67">    dataFile.setOwner(owner);</span>
<span class="fc" id="L68">    dataFile.setAccessLevel(request.getAccessLevel());</span>

    // 处理列定义
<span class="pc bpc" id="L71" title="1 of 2 branches missed.">    if (request.getColumnDefinitions() != null) {</span>
<span class="fc" id="L72">      List&lt;DataFile.ColumnDefinition&gt; columnDefinitions = request.getColumnDefinitions().stream()</span>
<span class="fc" id="L73">          .map(this::convertToColumnDefinition).collect(Collectors.toList());</span>
<span class="fc" id="L74">      dataFile.setColumnDefinitions(columnDefinitions);</span>
<span class="fc" id="L75">      dataFile.setColumnCount(columnDefinitions.size());</span>
    }

    // 处理数据行
<span class="pc bpc" id="L79" title="1 of 2 branches missed.">    if (request.getDataRows() != null) {</span>
<span class="fc" id="L80">      dataFile.setDataRows(request.getDataRows());</span>
<span class="fc" id="L81">      dataFile.setRowCount(request.getDataRows().size());</span>
    }

    // 生成文件哈希
<span class="fc" id="L85">    String fileHash = generateFileHash(dataFile);</span>
<span class="fc" id="L86">    dataFile.setFileHash(fileHash);</span>

    // 设置审计信息
<span class="fc" id="L89">    dataFile.setCreatedBy(currentUsername);</span>
<span class="fc" id="L90">    dataFile.setUpdatedBy(currentUsername);</span>

<span class="fc" id="L92">    DataFile savedDataFile = dataFileRepository.save(dataFile);</span>
<span class="fc" id="L93">    log.info(&quot;Data file created with ID: {}&quot;, savedDataFile.getId());</span>

<span class="fc" id="L95">    return convertToDto(savedDataFile);</span>
  }

  @Transactional
  public DataFileDto updateDataFile(Long id, UpdateDataFileRequest request) {
<span class="fc" id="L100">    log.info(&quot;Updating data file with ID: {}&quot;, id);</span>
<span class="fc" id="L101">    DataFile existingDataFile = dataFileRepository.findById(id)</span>
<span class="pc" id="L102">        .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;数据文件不存在，ID: &quot; + id));</span>

    // 检查权限（只有所有者可以修改）
<span class="fc" id="L105">    String currentUsername = SecurityContextHolder.getContext().getAuthentication().getName();</span>
<span class="pc bpc" id="L106" title="1 of 2 branches missed.">    if (!existingDataFile.getOwner().getUsername().equals(currentUsername)) {</span>
<span class="nc" id="L107">      throw new BusinessException(&quot;只有文件所有者可以修改数据文件&quot;);</span>
    }

    // 更新基本信息
<span class="pc bpc" id="L111" title="2 of 4 branches missed.">    if (request.getName() != null &amp;&amp; !request.getName().equals(existingDataFile.getName())) {</span>
<span class="pc bpc" id="L112" title="1 of 2 branches missed.">      if (dataFileRepository.existsByNameAndOrganizationNodeIdAndIdIsNot(request.getName(),</span>
<span class="fc" id="L113">          existingDataFile.getOrganizationNode().getId(), id)) {</span>
<span class="nc" id="L114">        throw new BusinessException(&quot;在同一模块下，数据文件名已存在: &quot; + request.getName());</span>
      }
<span class="fc" id="L116">      existingDataFile.setName(request.getName());</span>
    }

<span class="pc bpc" id="L119" title="1 of 2 branches missed.">    if (request.getDescription() != null) {</span>
<span class="fc" id="L120">      existingDataFile.setDescription(request.getDescription());</span>
    }

<span class="pc bpc" id="L123" title="1 of 2 branches missed.">    if (request.getAccessLevel() != null) {</span>
<span class="fc" id="L124">      existingDataFile.setAccessLevel(request.getAccessLevel());</span>
    }

    // 更新列定义
<span class="pc bpc" id="L128" title="1 of 2 branches missed.">    if (request.getColumnDefinitions() != null) {</span>
<span class="nc" id="L129">      List&lt;DataFile.ColumnDefinition&gt; columnDefinitions = request.getColumnDefinitions().stream()</span>
<span class="nc" id="L130">          .map(this::convertToColumnDefinition).collect(Collectors.toList());</span>
<span class="nc" id="L131">      existingDataFile.setColumnDefinitions(columnDefinitions);</span>
<span class="nc" id="L132">      existingDataFile.setColumnCount(columnDefinitions.size());</span>
    }

    // 更新数据行
<span class="pc bpc" id="L136" title="1 of 2 branches missed.">    if (request.getDataRows() != null) {</span>
<span class="nc" id="L137">      existingDataFile.setDataRows(request.getDataRows());</span>
<span class="nc" id="L138">      existingDataFile.setRowCount(request.getDataRows().size());</span>
    }

    // 重新生成文件哈希
<span class="fc" id="L142">    String newFileHash = generateFileHash(existingDataFile);</span>
<span class="fc" id="L143">    existingDataFile.setFileHash(newFileHash);</span>

    // 更新审计信息
<span class="fc" id="L146">    existingDataFile.setUpdatedBy(currentUsername);</span>
<span class="fc" id="L147">    existingDataFile.setUpdatedAt(LocalDateTime.now());</span>

<span class="fc" id="L149">    DataFile updatedDataFile = dataFileRepository.save(existingDataFile);</span>
<span class="fc" id="L150">    log.info(&quot;Data file updated with ID: {}&quot;, updatedDataFile.getId());</span>

<span class="fc" id="L152">    return convertToDto(updatedDataFile);</span>
  }

  @Transactional
  public void deleteDataFile(Long id) {
<span class="fc" id="L157">    log.info(&quot;Deleting data file with ID: {}&quot;, id);</span>
<span class="fc" id="L158">    DataFile existingDataFile = dataFileRepository.findById(id)</span>
<span class="pc" id="L159">        .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;数据文件不存在，ID: &quot; + id));</span>

    // 检查权限（只有所有者可以删除）
<span class="fc" id="L162">    String currentUsername = SecurityContextHolder.getContext().getAuthentication().getName();</span>
<span class="pc bpc" id="L163" title="1 of 2 branches missed.">    if (!existingDataFile.getOwner().getUsername().equals(currentUsername)) {</span>
<span class="nc" id="L164">      throw new BusinessException(&quot;只有文件所有者可以删除数据文件&quot;);</span>
    }

<span class="fc" id="L167">    dataFileRepository.delete(existingDataFile);</span>
<span class="fc" id="L168">    log.info(&quot;Data file deleted with ID: {}&quot;, id);</span>
<span class="fc" id="L169">  }</span>

  @Transactional(readOnly = true)
  public DataFileDto getDataFileById(Long id) {
<span class="fc" id="L173">    log.debug(&quot;Fetching data file by ID: {}&quot;, id);</span>
<span class="fc" id="L174">    DataFile dataFile = dataFileRepository.findById(id)</span>
<span class="fc" id="L175">        .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;数据文件不存在，ID: &quot; + id));</span>

    // 检查访问权限
<span class="fc" id="L178">    String currentUsername = SecurityContextHolder.getContext().getAuthentication().getName();</span>
<span class="fc" id="L179">    User currentUser = userRepository.findByUsername(currentUsername)</span>
<span class="pc" id="L180">        .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;用户不存在: &quot; + currentUsername));</span>

<span class="pc bpc" id="L182" title="1 of 2 branches missed.">    if (dataFile.getAccessLevel() == DataFile.AccessLevel.PRIVATE</span>
<span class="pc bpc" id="L183" title="1 of 2 branches missed.">        &amp;&amp; !dataFile.getOwner().getId().equals(currentUser.getId())) {</span>
<span class="nc" id="L184">      throw new BusinessException(&quot;没有权限访问此数据文件&quot;);</span>
    }

<span class="fc" id="L187">    return convertToDto(dataFile);</span>
  }

  @Transactional(readOnly = true)
  public Page&lt;DataFileDto&gt; queryDataFiles(DataFileQueryRequest request) {
<span class="fc" id="L192">    log.debug(&quot;Querying data files with conditions: {}&quot;, request);</span>

    // 构建分页和排序
<span class="fc" id="L195">    Sort sort = Sort.by(Sort.Direction.fromString(request.getSortDirection()), request.getSortBy());</span>
<span class="fc" id="L196">    Pageable pageable = PageRequest.of(request.getPage() - 1, request.getSize(), sort);</span>

    // 执行查询 - 使用最简单的查询避免PostgreSQL问题
<span class="fc" id="L199">    Page&lt;DataFile&gt; dataFiles = dataFileRepository.findAll(pageable);</span>

    // 过滤用户可访问的文件
<span class="fc" id="L202">    String currentUsername = SecurityContextHolder.getContext().getAuthentication().getName();</span>
<span class="fc" id="L203">    User currentUser = userRepository.findByUsername(currentUsername)</span>
<span class="pc" id="L204">        .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;用户不存在: &quot; + currentUsername));</span>

<span class="fc" id="L206">    List&lt;DataFileDto&gt; accessibleFiles = dataFiles.getContent().stream()</span>
<span class="fc bfc" id="L207" title="All 2 branches covered.">        .filter(df -&gt; df.getAccessLevel() == DataFile.AccessLevel.PUBLIC</span>
<span class="fc bfc" id="L208" title="All 2 branches covered.">            || df.getOwner().getId().equals(currentUser.getId()))</span>
<span class="fc" id="L209">        .map(this::convertToDto).collect(Collectors.toList());</span>

<span class="fc" id="L211">    return new org.springframework.data.domain.PageImpl&lt;&gt;(accessibleFiles, pageable,</span>
<span class="fc" id="L212">        accessibleFiles.size());</span>
  }

  @Transactional(readOnly = true)
  public List&lt;DataFileDto&gt; getDataFilesByOrganizationNode(Long organizationNodeId) {
<span class="fc" id="L217">    log.debug(&quot;Fetching data files for organization node ID: {}&quot;, organizationNodeId);</span>
<span class="fc" id="L218">    List&lt;DataFile&gt; dataFiles =</span>
<span class="fc" id="L219">        dataFileRepository.findByOrganizationNodeIdOrderByCreatedAtDesc(organizationNodeId);</span>

    // 过滤用户可访问的文件
<span class="fc" id="L222">    String currentUsername = SecurityContextHolder.getContext().getAuthentication().getName();</span>
<span class="fc" id="L223">    User currentUser = userRepository.findByUsername(currentUsername)</span>
<span class="pc" id="L224">        .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;用户不存在: &quot; + currentUsername));</span>

<span class="fc" id="L226">    return dataFiles.stream()</span>
<span class="pc bpc" id="L227" title="1 of 2 branches missed.">        .filter(df -&gt; df.getAccessLevel() == DataFile.AccessLevel.PUBLIC</span>
<span class="pc bnc" id="L228" title="All 2 branches missed.">            || df.getOwner().getId().equals(currentUser.getId()))</span>
<span class="fc" id="L229">        .map(this::convertToDto).collect(Collectors.toList());</span>
  }

  @Transactional(readOnly = true)
  public List&lt;DataFileDto&gt; getDataFilesByOwner(Long ownerId) {
<span class="nc" id="L234">    log.debug(&quot;Fetching data files for owner ID: {}&quot;, ownerId);</span>
<span class="nc" id="L235">    List&lt;DataFile&gt; dataFiles = dataFileRepository.findByOwnerIdOrderByCreatedAtDesc(ownerId);</span>
<span class="nc" id="L236">    return dataFiles.stream().map(this::convertToDto).collect(Collectors.toList());</span>
  }

  @Transactional(readOnly = true)
  public List&lt;DataFileDto&gt; searchDataFiles(String keyword) {
<span class="nc" id="L241">    log.debug(&quot;Searching data files with keyword: {}&quot;, keyword);</span>
<span class="nc" id="L242">    List&lt;DataFile&gt; dataFiles =</span>
<span class="nc" id="L243">        dataFileRepository.findByNameContainingIgnoreCaseOrderByCreatedAtDesc(keyword);</span>

    // 过滤用户可访问的文件
<span class="nc" id="L246">    String currentUsername = SecurityContextHolder.getContext().getAuthentication().getName();</span>
<span class="nc" id="L247">    User currentUser = userRepository.findByUsername(currentUsername)</span>
<span class="nc" id="L248">        .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;用户不存在: &quot; + currentUsername));</span>

<span class="nc" id="L250">    return dataFiles.stream()</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">        .filter(df -&gt; df.getAccessLevel() == DataFile.AccessLevel.PUBLIC</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">            || df.getOwner().getId().equals(currentUser.getId()))</span>
<span class="nc" id="L253">        .map(this::convertToDto).collect(Collectors.toList());</span>
  }

  @Transactional(readOnly = true)
  public List&lt;DataFileDto&gt; getDataFilesByDataType(DataFile.ColumnDefinition.DataType dataType) {
<span class="fc" id="L258">    log.debug(&quot;Fetching data files by data type: {}&quot;, dataType);</span>
<span class="fc" id="L259">    List&lt;DataFile&gt; allDataFiles = dataFileRepository.findAllDataFiles();</span>

    // 过滤用户可访问的文件和包含指定数据类型的文件
<span class="fc" id="L262">    String currentUsername = SecurityContextHolder.getContext().getAuthentication().getName();</span>
<span class="fc" id="L263">    User currentUser = userRepository.findByUsername(currentUsername)</span>
<span class="pc" id="L264">        .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;用户不存在: &quot; + currentUsername));</span>

<span class="fc" id="L266">    return allDataFiles.stream()</span>
<span class="fc bfc" id="L267" title="All 2 branches covered.">        .filter(df -&gt; df.getAccessLevel() == DataFile.AccessLevel.PUBLIC</span>
<span class="pc bpc" id="L268" title="1 of 2 branches missed.">            || df.getOwner().getId().equals(currentUser.getId()))</span>
<span class="pc bpc" id="L269" title="1 of 2 branches missed.">        .filter(df -&gt; df.getColumnDefinitions() != null</span>
<span class="fc bfc" id="L270" title="All 4 branches covered.">            &amp;&amp; df.getColumnDefinitions().stream().anyMatch(cd -&gt; cd.getDataType() == dataType))</span>
<span class="fc" id="L271">        .map(this::convertToDto).collect(Collectors.toList());</span>
  }

  @Transactional(readOnly = true)
  public List&lt;DataFileDto&gt; getRecentDataFiles(int limit) {
<span class="fc" id="L276">    log.debug(&quot;Fetching recent data files with limit: {}&quot;, limit);</span>
<span class="fc" id="L277">    Pageable pageable = PageRequest.of(0, limit, Sort.by(Sort.Direction.DESC, &quot;createdAt&quot;));</span>
<span class="fc" id="L278">    List&lt;DataFile&gt; dataFiles = dataFileRepository.findRecentDataFiles(pageable);</span>

    // 过滤用户可访问的文件
<span class="fc" id="L281">    String currentUsername = SecurityContextHolder.getContext().getAuthentication().getName();</span>
<span class="fc" id="L282">    User currentUser = userRepository.findByUsername(currentUsername)</span>
<span class="pc" id="L283">        .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;用户不存在: &quot; + currentUsername));</span>

<span class="fc" id="L285">    return dataFiles.stream()</span>
<span class="fc bfc" id="L286" title="All 2 branches covered.">        .filter(df -&gt; df.getAccessLevel() == DataFile.AccessLevel.PUBLIC</span>
<span class="pc bpc" id="L287" title="1 of 2 branches missed.">            || df.getOwner().getId().equals(currentUser.getId()))</span>
<span class="fc" id="L288">        .map(this::convertToDto).collect(Collectors.toList());</span>
  }

  @Transactional(readOnly = true)
  public Map&lt;String, Object&gt; getDataFileStatistics() {
<span class="fc" id="L293">    log.debug(&quot;Fetching data file statistics&quot;);</span>

    // 直接使用Repository方法计算统计信息，避免复杂的查询
<span class="fc" id="L296">    long totalFiles = dataFileRepository.count();</span>
<span class="fc" id="L297">    long publicFiles = dataFileRepository.countByAccessLevel(DataFile.AccessLevel.PUBLIC);</span>
<span class="fc" id="L298">    long privateFiles = dataFileRepository.countByAccessLevel(DataFile.AccessLevel.PRIVATE);</span>

    // 计算平均行数和列数
<span class="fc" id="L301">    List&lt;DataFile&gt; allFiles = dataFileRepository.findAll();</span>
<span class="pc bpc" id="L302" title="1 of 2 branches missed.">    double avgRowCount = allFiles.isEmpty() ? 0.0</span>
<span class="pc bpc" id="L303" title="1 of 2 branches missed.">        : allFiles.stream().mapToInt(df -&gt; df.getRowCount() != null ? df.getRowCount() : 0)</span>
<span class="fc" id="L304">            .average().orElse(0.0);</span>
<span class="pc bpc" id="L305" title="1 of 2 branches missed.">    double avgColumnCount = allFiles.isEmpty() ? 0.0</span>
<span class="pc bpc" id="L306" title="1 of 2 branches missed.">        : allFiles.stream().mapToInt(df -&gt; df.getColumnCount() != null ? df.getColumnCount() : 0)</span>
<span class="fc" id="L307">            .average().orElse(0.0);</span>

<span class="fc" id="L309">    Map&lt;String, Object&gt; statistics = new HashMap&lt;&gt;();</span>
<span class="fc" id="L310">    statistics.put(&quot;totalFiles&quot;, totalFiles);</span>
<span class="fc" id="L311">    statistics.put(&quot;publicFiles&quot;, publicFiles);</span>
<span class="fc" id="L312">    statistics.put(&quot;privateFiles&quot;, privateFiles);</span>
<span class="fc" id="L313">    statistics.put(&quot;avgRowCount&quot;, avgRowCount);</span>
<span class="fc" id="L314">    statistics.put(&quot;avgColumnCount&quot;, avgColumnCount);</span>

<span class="fc" id="L316">    return statistics;</span>
  }

  // 私有辅助方法
  private DataFile.ColumnDefinition convertToColumnDefinition(
      CreateDataFileRequest.ColumnDefinitionRequest request) {
<span class="fc" id="L322">    DataFile.ColumnDefinition columnDef = new DataFile.ColumnDefinition();</span>
<span class="fc" id="L323">    columnDef.setName(request.getName());</span>
<span class="fc" id="L324">    columnDef.setDataType(request.getDataType());</span>
<span class="fc" id="L325">    columnDef.setRequired(request.getRequired());</span>
<span class="fc" id="L326">    columnDef.setDefaultValue(request.getDefaultValue());</span>
<span class="fc" id="L327">    columnDef.setMaxLength(request.getMaxLength());</span>
<span class="fc" id="L328">    return columnDef;</span>
  }

  private DataFile.ColumnDefinition convertToColumnDefinition(
      UpdateDataFileRequest.ColumnDefinitionRequest request) {
<span class="nc" id="L333">    DataFile.ColumnDefinition columnDef = new DataFile.ColumnDefinition();</span>
<span class="nc" id="L334">    columnDef.setName(request.getName());</span>
<span class="nc" id="L335">    columnDef.setDataType(request.getDataType());</span>
<span class="nc" id="L336">    columnDef.setRequired(request.getRequired());</span>
<span class="nc" id="L337">    columnDef.setDefaultValue(request.getDefaultValue());</span>
<span class="nc" id="L338">    columnDef.setMaxLength(request.getMaxLength());</span>
<span class="nc" id="L339">    return columnDef;</span>
  }

  private String generateFileHash(DataFile dataFile) {
    try {
<span class="fc" id="L344">      String content = dataFile.getName() + dataFile.getDescription()</span>
<span class="fc" id="L345">          + dataFile.getColumnDefinitions().toString() + dataFile.getDataRows().toString();</span>

<span class="fc" id="L347">      MessageDigest md = MessageDigest.getInstance(&quot;MD5&quot;);</span>
<span class="fc" id="L348">      byte[] hashBytes = md.digest(content.getBytes());</span>

<span class="fc" id="L350">      StringBuilder sb = new StringBuilder();</span>
<span class="fc bfc" id="L351" title="All 2 branches covered.">      for (byte b : hashBytes) {</span>
<span class="fc" id="L352">        sb.append(String.format(&quot;%02x&quot;, b));</span>
      }
<span class="fc" id="L354">      return sb.toString();</span>
<span class="nc" id="L355">    } catch (NoSuchAlgorithmException e) {</span>
<span class="nc" id="L356">      throw new RuntimeException(&quot;Error generating file hash&quot;, e);</span>
    }
  }

  private String buildOrganizationPath(OrganizationNode node) {
<span class="fc" id="L361">    List&lt;String&gt; pathParts = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L362">    OrganizationNode current = node;</span>

<span class="fc bfc" id="L364" title="All 2 branches covered.">    while (current != null) {</span>
<span class="fc" id="L365">      pathParts.add(0, current.getName());</span>
<span class="fc bfc" id="L366" title="All 2 branches covered.">      current = current.getParentId() != null</span>
<span class="fc" id="L367">          ? organizationNodeRepository.findById(current.getParentId()).orElse(null)</span>
<span class="fc" id="L368">          : null;</span>
    }

<span class="fc" id="L371">    return String.join(&quot;/&quot;, pathParts);</span>
  }

  private DataFileDto convertToDto(DataFile dataFile) {
<span class="fc" id="L375">    return DataFileDto.builder().id(dataFile.getId()).name(dataFile.getName())</span>
<span class="fc" id="L376">        .description(dataFile.getDescription()).fileHash(dataFile.getFileHash())</span>
<span class="fc" id="L377">        .organizationNodeId(dataFile.getOrganizationNode().getId())</span>
<span class="fc" id="L378">        .organizationNodeName(dataFile.getOrganizationNode().getName())</span>
<span class="fc" id="L379">        .organizationNodePath(buildOrganizationPath(dataFile.getOrganizationNode()))</span>
<span class="fc" id="L380">        .ownerId(dataFile.getOwner().getId())</span>
<span class="pc bpc" id="L381" title="1 of 2 branches missed.">        .ownerName(dataFile.getOwner().getFullName() != null ? dataFile.getOwner().getFullName()</span>
<span class="nc" id="L382">            : dataFile.getOwner().getUsername())</span>
<span class="fc" id="L383">        .accessLevel(dataFile.getAccessLevel())</span>
<span class="fc" id="L384">        .columnDefinitions(convertColumnDefinitionsToDto(dataFile.getColumnDefinitions()))</span>
<span class="fc" id="L385">        .dataRows(dataFile.getDataRows()).rowCount(dataFile.getRowCount())</span>
<span class="fc" id="L386">        .columnCount(dataFile.getColumnCount()).createdAt(dataFile.getCreatedAt())</span>
<span class="fc" id="L387">        .updatedAt(dataFile.getUpdatedAt()).createdBy(dataFile.getCreatedBy())</span>
<span class="fc" id="L388">        .updatedBy(dataFile.getUpdatedBy())</span>
<span class="fc bfc" id="L389" title="All 2 branches covered.">        .versionCount(dataFile.getVersions() != null ? dataFile.getVersions().size() : 0)</span>
<span class="fc" id="L390">        .lastModifiedBy(dataFile.getUpdatedBy()).lastModifiedAt(dataFile.getUpdatedAt()).build();</span>
  }

  private List&lt;DataFileDto.ColumnDefinitionDto&gt; convertColumnDefinitionsToDto(
      List&lt;DataFile.ColumnDefinition&gt; columnDefinitions) {
<span class="pc bpc" id="L395" title="1 of 2 branches missed.">    if (columnDefinitions == null) {</span>
<span class="nc" id="L396">      return new ArrayList&lt;&gt;();</span>
    }

<span class="fc" id="L399">    return columnDefinitions.stream()</span>
<span class="fc" id="L400">        .map(cd -&gt; DataFileDto.ColumnDefinitionDto.builder().name(cd.getName())</span>
<span class="fc" id="L401">            .dataType(cd.getDataType()).required(cd.getRequired())</span>
<span class="fc" id="L402">            .defaultValue(cd.getDefaultValue()).maxLength(cd.getMaxLength()).build())</span>
<span class="fc" id="L403">        .collect(Collectors.toList());</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>